---
title: "Element network analysis with `dragon`"
author: "Stephanie J. Spielman* and Naman Srivastava"
date: "*Contact: stephanie.spielman@gmail.com"
output: 
  html_document:
    highlight: pygments
    theme: lumen
    toc: true
editor_options: 
  chunk_output_type: inline
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, include=TRUE)
library(tidyverse)
library(dragon)
library(broom)
library(performance)
library(ggtext)
library(ggrepel)
library(cowplot)

theme_set(theme_classic() + theme(plot.subtitle = element_markdown()))

# ggrepel labeling
label.color <- "darkgreen"
label.size <- 4.5

# output figure paths
fig_dir <- "figures"
ms_fig1_file <- file.path(fig_dir, "figure1.pdf")
ms_fig2_file <- file.path(fig_dir, "figure2.pdf")

#load utils
source("utils.R")

```

<br><br>

### Data preparation

First, we create a dataset containing element network information joined with other attributes of elements. We specifically _only consider elements that are known to form at least five minerals on Earth since 4.33 Ga._ The following elements are therefore excluded (in parentheses is given the number of minerals it forms): Dy (1), Er (1), Gd (1), Hf (1), Sm (1), Re (2), Rb (3). 

```{r build_all_networks, include=FALSE}
mineral_threshold <- 5


dragon:::element_info %>%
  # Not present since 4.33 Ga
  filter(element != "Tc") -> elements

purrr::map_df(elements$element, parse_element_network) %>%
  left_join(elements) %>%
  mutate(n_elements = as.numeric(n_elements),
         n_minerals = as.numeric(n_minerals),
         n_localities = as.numeric(n_localities)) %>%
  filter(n_minerals >= mineral_threshold) -> element_networks_info
```


Here is the full dataset used for analysis:

```{r element_networks_info}
element_networks_info
```

<br><br>

### Analysis 1: What is the relationship between number of elements interacted with and number of minerals formed? This analysis asks if number of elements can explain number of minerals.


<br>5
First, we explore whether we should likely transform an axis on a log-scale. Model diagnostics are shown below for the model with _log y and untransformed x_, whose diagnostics best meet assumptions.
<br>

```{r model1_diagnose, fig.height=5, fig.width=5}
# regression

# No
#lm(n_minerals ~ n_elements, data = element_networks_info) -> model_plain
#performance::check_model(model_plain)

# Yes
lm(log(n_minerals) ~ n_elements, data = element_networks_info) -> model_ylog
performance::check_model(model_ylog)

# No
#lm(n_minerals ~ log(n_elements), data = element_networks_info) -> model_xlog
#performance::check_model(model_xlog)

# No
#lm(log(n_minerals) ~ log(n_elements), data = element_networks_info) -> model_xlog_ylog
#performance::check_model(model_xlog_ylog)
```


<br><br>

**The resulting model is as follows - _THERE IS A POSITIVE RELATIONSHIP._**


```{r model1_plot, fig.height=4, fig.width=6}


get_model_info(model_ylog, "n_elements") -> model_info


make_plot(
  element_networks_info %>% mutate(n_minerals_log = log(n_minerals)),
  n_elements,
  n_minerals_log,
  model_info,
  "Number of Elements",
  "Log Number of Minerals",
  c("C", "H", "O", "N", "P", "S"),
  4 #seed
) -> model1_plot


model1_plot
```




### Analysis 2: What is the relationship between number of elements interacted with and number of localities it is found at? This analysis asks if number of elements can explain number of localities.


<br>
First, we explore whether we should likely transform an axis on a log-scale. Model diagnostics are shown below for the model with _log y and untransformed x_, whose diagnostics best meet assumptions.
<br>

```{r model2_diagnose, fig.height=5, fig.width=5}
# regression

# No
#lm(n_localities ~ n_elements, data = element_networks_info) -> model_plain
#performance::check_model(model_plain)

# Yes
lm(log(n_localities) ~ n_elements, data = element_networks_info) -> model_ylog
performance::check_model(model_ylog)

# No
#lm(n_localities ~ log(n_elements), data = element_networks_info) -> model_xlog
#performance::check_model(model_xlog)

# No
#lm(log(n_localities) ~ log(n_elements), data = element_networks_info) -> model_xlog_ylog
#performance::check_model(model_xlog_ylog)
```


<br><br>

**The resulting model is as follows - _THERE IS A POSITIVE RELATIONSHIP._**

```{r model2_plot, fig.height=4, fig.width=6}


get_model_info(model_ylog, "n_elements") -> model_info

make_plot(
  element_networks_info %>% mutate(n_localities_log = log(n_localities)),
  n_elements,
  n_localities_log,
  model_info,
  "Number of Elements",
  "Log Number of Localities",
  c("C", "H", "O", "N", "Au", "P"),
  10
) -> model2_plot

# S and P have to be labeled separately
model2_plot + 
  geom_text(
    aes(label = ifelse(element == "S", "S", "")),
    nudge_y = 0.2,
    nudge_x = -1,
    fontface = "bold",
    color = label.color,
    size = label.size
  ) 

model2_plot

```




### Analysis 3: What is the relationship between number of elements interacted with and percentage of crust? This analysis asks if element crust percentage by weight can explain the number of elements.

> Note that there are six elements which do not appear in this analysis because they are missing crust data - C, H, N, REE (rare earth elements), Rh, Te.

<br>

First, we explore whether we should likely transform an axis on a log-scale. Model diagnostics are shown below for the model with _log x and untransformed y_, whose diagnostics best meet assumptions.

<br>

```{r model3_diagnose, fig.height=5, fig.width=5}
# regression

# No
#lm(n_elements ~ element_crust_percent_weight, data = element_networks_info) -> model_plain
#performance::check_model(model_plain)

# No
#lm(log(n_elements) ~ element_crust_percent_weight, data = element_networks_info) -> model_ylog
performance::check_model(model_ylog)

# Yes
lm(n_elements ~ log(element_crust_percent_weight), data = element_networks_info) -> model_xlog
performance::check_model(model_xlog)

# No
#lm(log(n_elements) ~ log(element_crust_percent_weight), data = element_networks_info) -> model_xlog_ylog
#performance::check_model(model_xlog_ylog)
```




<br><br>

**The resulting model is as follows - _THERE IS A POSITIVE RELATIONSHIP._**

```{r model3_plot, fig.height=4, fig.width=6}
# Since we have a logged x, have to remake model:
element_networks_info %>%
  mutate(element_crust_percent_weight_log = log(element_crust_percent_weight)) -> forfit
lm(n_elements ~ element_crust_percent_weight_log, data = forfit) -> model_xlog
get_model_info(model_xlog, "element_crust_percent_weight_log") -> model_info


make_plot(
  element_networks_info %>% 
    mutate(element_crust_percent_weight_log = log(element_crust_percent_weight)),
  element_crust_percent_weight_log,
  n_elements,
  model_info,
  "Log crust percentage",
  "Number of Elements",
  c("As", "Pb", "Cu", "S", "O", "Fe", "Mn", "Zn", "P", "Mo", "Co", "Br", "Sc", "Yb", "Ga"),
  11
) -> model3_plot

# P and Ni separately, except the bottom P just allows the first P....
model3_plot + 
  # This is an insane hack for P and I DO NOT REGRET IT!!
  geom_text(
    aes(label = ifelse(element == "P", "P", "")),
    nudge_y = 2,
    nudge_x = 0,
    fontface = "bold",
    color = "white",
    size = label.size
  ) +
  geom_text(
    aes(label = ifelse(element == "Ni", "Ni", "")),
    nudge_y = -2.5,
    nudge_x = -0.4,
    fontface = "bold",
    color = label.color,
    size = label.size
  )



model3_plot

```



### Analysis 4: What is the relationship between number of elements interacted with and electronegativity? This analysis asks if the number of elements can explain the electronegativity.


<br>

First, we explore whether we should likely transform an axis on a log-scale. Model diagnostics are shown below for the model with _both untransformed y and x_, whose diagnostics best meet assumptions.

<br>

```{r model4_diagnose, fig.height=5, fig.width=5}
# Yes
lm(pauling ~ n_elements, data = element_networks_info) -> model_plain
performance::check_model(model_plain)

# No
#lm(log(pauling) ~ n_elements, data = element_networks_info) -> model_ylog
#performance::check_model(model_ylog)

# No
#lm(pauling ~ log(n_elements), data = element_networks_info) -> model_xlog
#performance::check_model(model_xlog)

# No
#lm(log(pauling) ~ log(n_elements), data = element_networks_info) -> model_xlog_ylog
#performance::check_model(model_xlog_ylog)
```





<br><br>

**The resulting model is as follows - _THERE IS NO RELATIONSHIP._:**

```{r model4_plot, fig.height=4, fig.width=6}

get_model_info(model_plain, "n_elements") -> model_info


make_plot(
  element_networks_info,
  n_elements,
  pauling,
  model_info,
  "Number of Elements",
  "Pauling electronegativity"
) -> model4_plot



model4_plot
```






### Analysis 5: What is the relationship between number of minerals formed and electronegativity? This analysis asks if the number of minerals can explain electronegativity.


<br>

First, we explore whether we should likely transform an axis on a log-scale. Model diagnostics are shown below for the model with _log y and untransformed x_, whose diagnostics best meet assumptions.

<br>

```{r model5_diagnose, fig.height=5, fig.width=5}

# No
#lm(n_minerals ~ pauling, data = element_networks_info) -> model_plain
#performance::check_model(model_plain)

# Yes
lm(log(n_minerals) ~ pauling, data = element_networks_info) -> model_ylog
performance::check_model(model_ylog)

# No
#lm(n_minerals ~ log(pauling), data = element_networks_info) -> model_xlog
#performance::check_model(model_xlog)

# No but close
#lm(log(pauling) ~ log(n_minerals), data = element_networks_info) -> model_xlog_ylog
#performance::check_model(model_xlog_ylog)
```


<br><br>

**The resulting model is as follows - _THERE IS NO RELATIONSHIP._**

```{r model_plot, fig.height=4, fig.width=6}

get_model_info(model_ylog, "pauling") -> model_info


make_plot(
  element_networks_info %>% mutate(n_minerals_log = log(n_minerals)),
  pauling,
  n_minerals_log,
  model_info,
  "Pauling electronegativity",
  "Log number of minerals formed"
) -> model5_plot



model5_plot
```

### Analysis 6: What is the relationship between atomic number (number of protons) and the number of elements interacted with? This analysis asks if the atomic number (number of protons) can explain the number of elements interacted with.
<br>

First, we explore whether we should likely transform an axis on a log-scale. Model diagnostics are shown below for the model with _both axes untransformed_; all diagnostics are about the same, so we'll use the regular data.

<br>

```{r model6_diagnose, fig.height=5, fig.width=5}
# Yes
lm(n_elements ~ number_of_protons, data = element_networks_info) -> model_plain
performance::check_model(model_plain)

# No
#lm(log(n_elements) ~ number_of_protons, data = element_networks_info) -> model_ylog
#performance::check_model(model_ylog)

# No
#lm(n_elements ~ log(number_of_protons), data = element_networks_info) -> model_xlog
#performance::check_model(model_xlog)

# No
#lm(log(n_elements) ~ log(number_of_protons), data = element_networks_info) -> model_xlog_ylog
#performance::check_model(model_xlog_ylog)
```


<br><br>

**The resulting model is as follows - THERE IS A NEGATIVE RELATIONSHIP.**

```{r model6_plot, fig.height=4, fig.width=6}

get_model_info(model_plain, "number_of_protons") -> model_info

make_plot(
  element_networks_info,
  n_elements,
  number_of_protons,
  model_info,
  "Number of Elements",
  "Atomic number", # variable is number_of_protons which is equivalent
   c("As", "Pb", "Cu", "S", "O", "Fe", "Mn", "P", "Zn", "Ni", "Co", "Br", "Sc", "Yb", "Ga", "C", "H", "N", "Bi", "U")
) -> model6_plot

# Mo is specifically annoying to label because it's ON the regression line
model6_plot +
  geom_text(
    aes(label = ifelse(element == "Mo", "Mo", "")),
    nudge_y = 3,
    fontface = "bold",
    color = label.color,
    size = label.size) -> model6_plot
model6_plot
```

<br><br>


### Figure export

Here we export figures to PDF files for use in manuscript.


##### Manuscript Figure 1

Figure 1 is two panels comprised of `model1_plot` and `model2_plot`.

```{r ms_fig1}
fig1_grid <- plot_grid(model1_plot, model2_plot, labels = "AUTO", nrow = 2)
save_plot(ms_fig1_file, fig1_grid, base_height = 10, base_width = 7)
```


Figure 2 is two panels comprised of `model3_plot` and `model6_plot`.

```{r ms_fig2}
fig2_grid <- plot_grid(model3_plot, model6_plot, labels = "AUTO", nrow = 2)
save_plot(ms_fig2_file, fig2_grid, base_height = 10, base_width = 7)
```



### Session Info

The following shows the R version and package versions loaded for this analysis to enable reproducibility.

```{r session_info}
sessionInfo()
```